name: Ez2Lazer Auto Release (build deps then package)

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'release or debug'
        required: true
        default: 'release'
      deps_branch:
        description: 'branch/ref to checkout for deps'
        required: true
        default: 'locmain'
  push:
    tags:
      - 'r-*'

jobs:
  build-and-package:
    runs-on: windows-latest

    steps:
      - name: Checkout main repo into osu/
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: osu

      - name: Checkout osu-framework (deps) as sibling
        uses: actions/checkout@v4
        with:
          repository: SK-la/osu-framework
          path: osu-framework
          # Explicitly request the locmain branch (use full ref to avoid ref parsing)
          ref: refs/heads/locmain
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate osu-framework checkout (Windows)
        shell: pwsh
        run: |
          if (-not (Test-Path 'osu-framework\.git')) {
            Write-Output 'actions/checkout did not populate osu-framework; attempting HTTPS clone fallback'
            git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/SK-la/osu-framework.git osu-framework
            Push-Location osu-framework
            git checkout locmain || Write-Output 'checkout locmain failed, continuing'
            Pop-Location
          } else {
            Write-Output 'osu-framework already present'
          }

      - name: Checkout osu-resources (resources) as sibling
        uses: actions/checkout@v4
        with:
          repository: SK-la/osu-resources
          path: osu-resources
          ref: refs/heads/locmain
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate osu-resources checkout (Windows)
        shell: pwsh
        run: |
          if (-not (Test-Path 'osu-resources\.git')) {
            Write-Output 'actions/checkout did not populate osu-resources; attempting HTTPS clone fallback'
            git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/SK-la/osu-resources.git osu-resources
            Push-Location osu-resources
            git checkout locmain || Write-Output 'checkout locmain failed, continuing'
            Pop-Location
          } else {
            Write-Output 'osu-resources already present'
          }

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Cache NuGet packages (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: C:\\Users\\runneradmin\\.nuget\\packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/Directory.Packages.props','**/*.csproj','**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Dotnet restore (desktop project)
        working-directory: osu
        shell: pwsh
        run: |
          dotnet --info
          dotnet restore ./osu.Desktop/osu.Desktop.csproj

      - name: Dotnet build (desktop project)
        working-directory: osu
        shell: pwsh
        run: |
          dotnet build ./osu.Desktop/osu.Desktop.csproj -c Release -p:GenerateFullPaths=true

      - name: Run publish script (pack & create release)
        working-directory: osu
        shell: pwsh
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          PYTHONUTF8: '1'
          PYTHONIOENCODING: 'utf-8'
        run: |
          # Compute tag inside PowerShell to avoid invalid YAML expressions
          $tag = '${{ github.event.inputs.tag }}'
          if (-not $tag) {
            if ($env:GITHUB_REF -match 'refs/tags/(.+)') { $tag = $matches[1] } else { $tag = "locmain-$env:GITHUB_RUN_NUMBER" }
          }
          Write-Output "Using TAG=$tag"
          # Explicitly pass project, workdir, and outroot so artifacts land under osu/artifacts
          $project = Join-Path (Get-Location) 'osu.Desktop\osu.Desktop.csproj'
          $workdir = (Get-Location).Path
          $outroot = Join-Path $workdir 'artifacts'
          python ./publish.py --project "$project" --workdir "$workdir" --outroot "$outroot" --deps-source none --resources-path "${{ github.workspace }}\osu-resources\osu.Game.Resources\Resources" --tag "$tag"

      - name: Debug publish environment (list files + --help)
        working-directory: osu
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Output "PWD: $(Get-Location)"
          Write-Output "Listing osu/ (first 200 entries)"
          Get-ChildItem -Recurse -Force -ErrorAction SilentlyContinue | Select-Object -First 200 | ForEach-Object { Write-Output $_.FullName }
          Write-Output "Python version:"
          python --version || Write-Output 'python --version failed'
          Write-Output "Dotnet info:"
          dotnet --info || Write-Output 'dotnet --info failed'
          Write-Output "Show the first 200 lines of publish.py"
          Get-Content publish.py -TotalCount 200 -ErrorAction SilentlyContinue || Write-Output 'cat publish.py failed'
          Write-Output "Running publish.py --help"
          python ./publish.py --help || Write-Output 'publish.py --help failed'

      - name: List produced artifacts
        shell: pwsh
        id: list_zips
        run: |
          Write-Output "Searching for zip files under $env:GITHUB_WORKSPACE, $env:GITHUB_WORKSPACE\osu and $env:GITHUB_WORKSPACE\osu\artifacts"
          $repoRoot = $env:GITHUB_WORKSPACE
          $p1 = $repoRoot
          $p2 = Join-Path $repoRoot 'osu'
          $p3 = Join-Path $repoRoot 'osu\artifacts'
          $paths = @($p1, $p2, $p3)
          $found = $null
          foreach ($p in $paths) {
            if (Test-Path $p) {
              Write-Output "Searching in: $p"
              $z = Get-ChildItem -Path $p -Filter *.zip -Recurse -ErrorAction SilentlyContinue | ForEach-Object { $_.FullName }
              if ($z -and $z.Count -gt 0) { $found = $z; break }
            }
          }
          if ($found) {
            Write-Output "Found zip(s): $found"
            $first = $found[0]
            $name = Split-Path -Path $first -Leaf
            Write-Output "zip_path=$first" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Output "zip_name=$name" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Output "No zip files found in searched locations."
          }

      - name: Export release tag and artifacts
        shell: pwsh
        id: export
        run: |
          $tag = '${{ github.event.inputs.tag }}'
          if (-not $tag) {
            if ($env:GITHUB_REF -match 'refs/tags/(.+)') { $tag = $matches[1] } else { $tag = "locmain-$env:GITHUB_RUN_NUMBER" }
          }
          Write-Output "RELEASE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          # Search common artifact locations: repo-root/artifacts, osu/artifacts, parent artifacts
          $candidates = @()
          $repoRoot = $env:GITHUB_WORKSPACE
          $candidates += Join-Path $repoRoot 'artifacts'
          $candidates += Join-Path $repoRoot 'osu\artifacts'
          $candidates += Join-Path $repoRoot '..\artifacts'
          $found = $null
          foreach ($p in $candidates) {
            if (Test-Path $p) {
              $zips = Get-ChildItem -Path $p -Filter *.zip -Recurse -ErrorAction SilentlyContinue | ForEach-Object { $_.FullName }
              if ($zips -and $zips.Count -gt 0) { $found = $zips; break }
            }
          }
          if ($found) {
            Write-Output "Found zips: $found"
            $first = $found[0]
            $name = Split-Path -Path $first -Leaf
            Write-Output "zip_path=$first" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Output "zip_name=$name" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Output "No zip artifacts found in expected locations: $candidates"
          }

      - name: Create or get GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release asset (from diagnostic list)
        if: steps.list_zips.outputs.zip_path != ''
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.list_zips.outputs.zip_path }}
          asset_name: ${{ steps.list_zips.outputs.zip_name }}
          asset_content_type: application/zip

      - name: Upload release asset (from export)
        if: steps.export.outputs.zip_path != '' && steps.list_zips.outputs.zip_path == ''
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.export.outputs.zip_path }}
          asset_name: ${{ steps.export.outputs.zip_name }}
          asset_content_type: application/zip

      - name: Upload release asset (from export)
        if: steps.export.outputs.zip_path != '' && steps.list_zips.outputs.zip_path == ''
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.export.outputs.zip_path }}
          asset_name: ${{ steps.export.outputs.zip_name }}
          asset_content_type: application/zip
