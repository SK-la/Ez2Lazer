// Copyright (c) ppy Pty Ltd <contact@ppy.sh>. Licensed under the MIT Licence.
// See the LICENCE file in the repository root for full licence text.

using System;
using System.Linq;
using osu.Framework.Allocation;
using osu.Framework.Bindables;
using osu.Framework.Localisation;
using osu.Game.Configuration;
using osu.Game.Rulesets.Mods;
using osu.Game.Rulesets.Scoring;

namespace osu.Game.Rulesets.Mania.Mods.LAsMods
{
    public class ManiaModFreeHit : Mod, IHitWindows
    {
        public override string Name => "Custom HitWindows";
        public override string Acronym => "CH";
        public override double ScoreMultiplier => 1;
        public override bool Ranked => false;
        public override LocalisableString Description => @"LaMod: Custom HitWindows. Free Hit ms.";
        public override ModType Type => ModType.CustomMod;

        [SettingSource("Adaptive Judgement(No Active)")]
        public BindableBool AdaptiveJudgement { get; } = new BindableBool();

        [SettingSource("Easy Style Judgement")]
        public BindableBool UseEasyTemplate { get; } = new BindableBool();

        [SettingSource("Hard Style Judgement")]
        public BindableBool UseHardTemplate { get; } = new BindableBool();

        [SettingSource("Perfect Offset (ms)")]
        public BindableNumber<double> PerfectOffset { get; } = new BindableDouble(22)
        {
            MinValue = 1,
            MaxValue = 60,
            Precision = 1
        };

        [SettingSource("Great Offset (ms)")]
        public BindableNumber<double> GreatOffset { get; } = new BindableDouble(42)
        {
            MinValue = 10,
            MaxValue = 120,
            Precision = 1
        };

        [SettingSource("Good Offset (ms)")]
        public BindableNumber<double> GoodOffset { get; } = new BindableDouble(82)
        {
            MinValue = 20,
            MaxValue = 180,
            Precision = 1
        };

        [SettingSource("Ok Offset (ms)")]
        public BindableNumber<double> OkOffset { get; } = new BindableDouble(120)
        {
            MinValue = 40,
            MaxValue = 240,
            Precision = 1
        };

        [SettingSource("Meh Offset (ms)")]
        public BindableNumber<double> MehOffset { get; } = new BindableDouble(150)
        {
            MinValue = 60,
            MaxValue = 300,
            Precision = 1
        };

        [SettingSource("Miss Offset (ms)")]
        public BindableNumber<double> MissOffset { get; } = new BindableDouble(180)
        {
            MinValue = 80,
            MaxValue = 500,
            Precision = 1
        };

        [Resolved]
        private ScoreProcessor scoreProcessor { get; set; } = null!;

        public ManiaModFreeHit()
        {
            // HitWindows.SetCustomRanges(this);

            UseEasyTemplate.BindValueChanged(e =>
            {
                if (e.NewValue)
                {
                    applyTemplate(HitWindowTemplates.EASY);
                    UseHardTemplate.Value = false;
                    AdaptiveJudgement.Value = false;
                }
            });
            UseHardTemplate.BindValueChanged(e =>
            {
                if (e.NewValue)
                {
                    applyTemplate(HitWindowTemplates.HARD);
                    UseEasyTemplate.Value = false;
                    AdaptiveJudgement.Value = false;
                }
            });
            AdaptiveJudgement.BindValueChanged(e =>
            {
                if (e.NewValue)
                {
                    UseHardTemplate.Value = false;
                    UseEasyTemplate.Value = false;

                    scoreProcessor?.Accuracy.BindValueChanged(acc => UpdateHitWindowsBasedOnScore(acc.NewValue), true);
                }
                // else
                // {
                //     scoreProcessor.Accuracy.UnbindAll();
                // }
            }, true);
            PerfectOffset.BindValueChanged(_ => updateHitWindows());
            GreatOffset.BindValueChanged(_ => updateHitWindows());
            GoodOffset.BindValueChanged(_ => updateHitWindows());
            OkOffset.BindValueChanged(_ => updateHitWindows());
            MehOffset.BindValueChanged(_ => updateHitWindows());
            MissOffset.BindValueChanged(_ => updateHitWindows());
        }

        ~ManiaModFreeHit()
        {
            HitWindows.SetModActive(false);
        }

        private void updateHitWindows()
        {
            HitWindows.SetModActive(true);
            HitWindows.SetCustomRanges(this);
        }

        // public void ApplyToScoreProcessor(ScoreProcessor scoreProcessor)
        // {
        // }

        // public AdjustRank(ScoreRank rank, double accuracy)
        // {
        //     return rank;
        // }

        private void applyTemplate(HitWindowTemplate template)
        {
            PerfectOffset.Value = template.PerfectOffset;
            GreatOffset.Value = template.GreatOffset;
            GoodOffset.Value = template.GoodOffset;
            OkOffset.Value = template.OkOffset;
            MehOffset.Value = template.MehOffset;
            MissOffset.Value = template.MissOffset;
        }

        public class HitWindowTemplate
        {
            public double PerfectOffset { get; set; }
            public double GreatOffset { get; set; }
            public double GoodOffset { get; set; }
            public double OkOffset { get; set; }
            public double MehOffset { get; set; }
            public double MissOffset { get; set; }
        }

        public static class HitWindowTemplates
        {
            public static readonly HitWindowTemplate EASY = new HitWindowTemplate
            {
                PerfectOffset = 50,
                GreatOffset = 100,
                GoodOffset = 150,
                OkOffset = 200,
                MehOffset = 250,
                MissOffset = 300
            };

            public static readonly HitWindowTemplate HARD = new HitWindowTemplate
            {
                PerfectOffset = 20,
                GreatOffset = 40,
                GoodOffset = 60,
                OkOffset = 80,
                MehOffset = 100,
                MissOffset = 120
            };

            // 可以添加更多模板
        }

        public void UpdateHitWindowsBasedOnScore(double accuracy)
        {
            if (accuracy != 0)
            {
                if (accuracy > 0.95)
                {
                    // 缩小判定区间
                    PerfectOffset.Value = 10;
                    GreatOffset.Value = 20;
                    GoodOffset.Value = 21;
                    OkOffset.Value = 90;
                    MehOffset.Value = 100;
                    MissOffset.Value = 120;
                }
                else if (accuracy < 0.95)
                {
                    // 放宽判定区间
                    PerfectOffset.Value = 30;
                    GreatOffset.Value = 60;
                    GoodOffset.Value = 100;
                    OkOffset.Value = 150;
                    MehOffset.Value = 151;
                    MissOffset.Value = 200;
                }
            }
        }

        public bool IsHitResultAllowed(HitResult result)
        {
            return result switch
            {
                HitResult.Perfect => true,
                HitResult.Great => true,
                HitResult.Good => true,
                HitResult.Ok => true,
                HitResult.Meh => true,
                HitResult.Miss => true,
                _ => false,
            };
        }

        public double WindowFor(HitResult result)
        {
            switch (result)
            {
                case HitResult.Perfect:
                    return PerfectOffset.Value;

                case HitResult.Great:
                    return GreatOffset.Value;

                case HitResult.Good:
                    return GoodOffset.Value;

                case HitResult.Ok:
                    return OkOffset.Value;

                case HitResult.Meh:
                    return MehOffset.Value;

                case HitResult.Miss:
                    return MissOffset.Value;

                default:
                    throw new ArgumentException("Unknown enum member", nameof(result));
            }
        }

        public DifficultyRange[] GetRanges() => new[]
        {
            new DifficultyRange(HitResult.Perfect, PerfectOffset.Value, PerfectOffset.Value, PerfectOffset.Value),
            new DifficultyRange(HitResult.Great, GreatOffset.Value, GreatOffset.Value, GreatOffset.Value),
            new DifficultyRange(HitResult.Good, GoodOffset.Value, GoodOffset.Value, GoodOffset.Value),
            new DifficultyRange(HitResult.Ok, OkOffset.Value, OkOffset.Value, OkOffset.Value),
            new DifficultyRange(HitResult.Meh, MehOffset.Value, MehOffset.Value, MehOffset.Value),
            new DifficultyRange(HitResult.Miss, MissOffset.Value, MissOffset.Value, MissOffset.Value),
        };

        public override string SettingDescription
        {
            get
            {
                string perfect = $"Perfect {PerfectOffset.Value}";
                string great = $"Great {GreatOffset.Value}";
                string good = $"Good {GoodOffset.Value}";
                string ok = $"Ok {OkOffset.Value}";
                string meh = $"Meh {MehOffset.Value}";
                string miss = $"Miss {MissOffset.Value}";
                return string.Join(", ", new[]
                {
                    perfect,
                    great,
                    good,
                    ok,
                    meh,
                    miss
                }.Where(s => !string.IsNullOrEmpty(s)));
            }
        }
    }
}
